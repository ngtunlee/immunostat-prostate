---
title: | 
  | Antibody Responses to Different Proteins 
  | in Prostate Cancer Patients  
author: "Tun Lee Ng and Michael A. Newton"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  pdf_document:
    toc: true
    number_sections: true
header-includes:
   \usepackage{enumerate}
   \usepackage{amsmath}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F, fig.pos = "H")
```

# Introduction

This project aims to characterize antibody responses to a wide variety of proteins in prostate cancer patients at different stages of the disease. 16-mer peptides spanning the amino acid sequences of these 1611 gene products, and overlapping by 12 amino acids, were used to generate a microarray comprising 177,604 peptides. In this study, there were healthy subjects and patients with different stages of prostate cancer  

*  ``new_dx``: newly diagnosed,  
* ``nmCSPC``: non-metastatic castration-sensitive,  
* ``mCSPC``: metastatic castration-sensitive,  
* ``nmCRPC``: non-metastatic castration-resistant,  
* ``mCRPC``: metastatic castration-resistant 

```{r}
library(tidyverse) # make sure you have the latest tidyverse !
library(fdrtool)
library(kableExtra)

array_id_key = read_csv("sample_key_project1.csv") %>%
  janitor::clean_names() %>%  # unify all column names to snake_case
  rename(stage = condition,
         array_id = "file_name") %>%
  mutate(id = str_replace_all(id, " ", ""),
         id = str_to_lower(id),
         id = str_replace_all(id, "/", ""),
         stage = as_factor(stage),
         stage = fct_recode(stage,  # rename factor levels
                            "normal" = "Normal_male_controls",
                            "new_dx" = "Newly_diagnosed",
                            "nmCSPC" = "PSA-recurrent_nonMet",
                            "mCSPC" = "Met",
                            "nmCRPC" = "Castration-resistent_nonMet",
                            "mCRPC" = "Castration-resistent_Met",
                            "binding_buffer" = "Binding buffer alone"))

# check patient counts (NOT distinct patients)
kable(array_id_key %>%
  group_by(id, stage) %>%
  summarize() %>%
  group_by(stage) %>%
  tally(), format = "latex", booktabs = T ) %>%
  kable_styling(latex_options = c("hold_position"))
```

Note that these are not distinct patient counts, because there were 11 patients who were measured at two different stages. Number of replicates for each patient, ``rep`` could 1, 2, or 3. Hemanth dropped patients with ``rep`` = 1. He also kept the latest distinct patient records only, so the distinct patient counts are:  

```{r}
# drop patients without replicates
sample_key = array_id_key %>%
  group_by(id, stage) %>%
  summarize(n = n()) %>%  # assign (id,stage) group counts to the variable "n"
  ungroup() %>% 
  filter(n >= 2) %>%
  select(-n) # drop the column "n"

array_id_key = array_id_key %>%
  filter(id %in% sample_key$id)

# drop unnecessary columns from array_id_key
array_id_key = array_id_key %>%
  select( -c(index, rep) ) # Hemanth says index column not helpful

# 11 patients with replicates in 2 stages
ids_to_remove = c("pdv004", #1
                  "arv003", #2
                  "pap092", #3
                  "pap032", #4
                  "adt034", #5
                  "adt181", #6
                  "adt223", #7
                  "pdv008", #8
                  "pap123", #9
                  "pap067", #10
                  "adt143") #11

array_id_key = array_id_key %>%
  filter(!(id %in% ids_to_remove))

# check patient counts (finally distinct patients)
distinct_patients_with_reps <- array_id_key %>%
  group_by(id, stage) %>%
  summarize() %>%
  group_by(stage) %>%
  tally()
kable(distinct_patients_with_reps, format = "latex", booktabs = T) %>%
  kable_styling(latex_options = c("hold_position"))
```

Hemanth has already checked that replicates for each patient largely "agree with one another". We compute the median fluorescence level for each patient and take $\log_2$ transformation of the median fluorescence intensity . 

```{r}
load("anova_pval.RData")

# function to count peptides at different FDR thresholds
count.func <- function(pval.vec, thresh.vec){
  counter <- NULL
  for (i in thresh.vec ){
    counter <- c(counter, length(pval.vec[pval.vec <= i]))
  }
  countab <- rbind(c("FDR threshold", thresh.vec),
                   c("Peptide counts", counter))
  return(countab)
}
```


# One-Way ANOVA

We would like to investigate if patients at different stages of prostate cancer exhibit different antibody responses to certain peptide chains or proteins. Let $\mu_i$ be the average fluorescence level (on $\log_2$ scale) of patients, with subscript $i$ indexing the different stages of prostate cancer as explained in Introduction section. We want to test  

$H_0$: All $\mu_i$'s are the same, ie. Antibody responses are the same for patients at different stages of prostate cancer.  
$H_1$: NOt all $\mu_i$'s are the same, ie. Antibody responses are not the same for patients at different stages of prostate cancer.  

For each peptide, we perform one-way ANOVA (analysis of variance). After getting p-values for all 177k peptides, we plot the p-value histogram.

```{r, include = F}
one_way_anova_BH <- p.adjust(one_way_anova_pval, method = "BH")
one_way_anova_qval <- fdrtool(one_way_anova_pval, statistic = "pvalue", verbose = F, plot  = F)$qval
qval_eta0 <- unname(fdrtool(one_way_anova_pval, statistic = "pvalue", verbose = F, plot  = F)$param[,"eta0"])
all_peptide_hist <- hist(one_way_anova_pval, breaks = 70, freq = F, 
                         xlab = "one-way ANOVA p-values", main = "p-values distribution for peptides")
```

```{r}
hist(one_way_anova_pval, breaks = 70, freq = F, xlab = "one-way ANOVA p-values", main = "p-values distribution for peptides")
polygon_ind <- which(all_peptide_hist$density >= qval_eta0)
for (i in polygon_ind){
  polygon( x = c(all_peptide_hist$breaks[i], all_peptide_hist$breaks[i+1], all_peptide_hist$breaks[i+1], all_peptide_hist$breaks[i]),
           y = c(all_peptide_hist$density[i], all_peptide_hist$density[i], qval_eta0, qval_eta0),
           col = "red")
}
```

The estimated proportion of non-null probes in the dataset based on ANOVA is

```{r}
1 - qval_eta0
```

The estimation is based on Storey's q-values computed with the R package ``fdrtool``. The q-value is similar to the well known p-value, except it is a measure of significance in terms of the false discovery rate rather than the false positive rate. The peptide counts at various FDR thresholds are tabulated below.

```{r}
kable( count.func(one_way_anova_qval, seq(0.01, 0.1, by = 0.01)),
       format = "latex", row.names= NA, col.names = NA, booktabs = T )%>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%
  row_spec(1, hline_after = T)
```

As a comparison, we also apply the Benjamini-Hochberg (BH) method on the ANOVA p-values to control for false discovery rate. The peptide counts at various FDR thresholds are tabulated below. 

```{r}
kable( count.func(one_way_anova_BH, seq(0.01, 0.1, by = 0.01)),
       format = "latex", row.names= NA, col.names = NA, booktabs = T )%>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%
  row_spec(1, hline_after = T)
```


# Marginal Variance Filtering 

Next, for every protein, we would like to filter the top few peptides with the largest marginal variance of $\log_2$ fluorescence among all patients. 

```{r}
load("median_data.RData")

# marginal variance filtering function
marginal_var_filter.func <- function(pval_vector, topnum){
  pval_filter = pval_vector[raw_data_median$rank_variance <= topnum]
  BH_filter = p.adjust(pval_filter, method = "BH")
  qval_filter = fdrtool(pval_filter, statistic = "pvalue", verbose = F, plot  = F)$qval
  qval_eta0_filter = unname(fdrtool(pval_filter, statistic = "pvalue", verbose = F, plot  = F)$param[,"eta0"])
  return(list(
    pval_filter = pval_filter,
    BH_filter = BH_filter,
    qval_filter = qval_filter,
    qval_eta0_filter = qval_eta0_filter
  ))
}
```

## Top 5 peptides with largest marginal variance

First, we filter top 5 peptides with largest marginal variance in each protein. Then we plot histogram of p-values.

```{r, include = F}
topnum <- 5
top <- marginal_var_filter.func(one_way_anova_pval, topnum)
top_plot <- hist(top$pval_filter, breaks = 70, freq = F, xlab = "one-way ANOVA p-values", 
                   main = paste("p-values distribution for top ", topnum, 
                                 "peptide(s) with largest variance within protein") )
```

```{r}
hist(top$pval_filter, breaks = 70, freq = F, xlab = "one-way ANOVA p-values", 
                   main = paste("p-values distribution for top", topnum, 
                                 "\npeptide(s) with largest variance within protein") )
polygon_ind <- which(top_plot$density >= top$qval_eta0_filter)
for (i in polygon_ind){
  polygon( x = c(top_plot$breaks[i], top_plot$breaks[i+1], top_plot$breaks[i+1], top_plot$breaks[i]),
           y = c(top_plot$density[i], top_plot$density[i], top$qval_eta0_filter, top$qval_eta0_filter),
           col = "red")
}
text(x=0.65,y=4, labels = paste( "estimated proportion of \nnon-null peptides =",
                                    round( 100*(1 - top$qval_eta0_filter),2 ),"%" ))
```

Next, we tabulate peptide counts at different BH-adjusted p-values thresholds.

```{r}
kable( count.func(top$BH_filter, seq(0.01, 0.1, by = 0.01)),
       format = "latex", row.names= NA, col.names = NA, booktabs = T )%>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%
  row_spec(1, hline_after = T)
```

Then, we tabulate peptide counts at different Storey's q-values thresholds. 

```{r}
kable( count.func(top$qval_filter, seq(0.01, 0.1, by = 0.01)),
       format = "latex", row.names= NA, col.names = NA, booktabs = T )%>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%
  row_spec(1, hline_after = T)
```

## Top 3 peptides with largest marginal variance

Now, we filter top 3 peptides with largest marginal variance in each protein. Then we plot histogram of p-values.

```{r, include = F}
topnum <- 3
top <- marginal_var_filter.func(one_way_anova_pval, topnum)
top_plot <- hist(top$pval_filter, breaks = 70, freq = F, xlab = "one-way ANOVA p-values", 
                   main = paste("p-values distribution for top", topnum, "\npeptide(s) with largest variance within protein") )
```

```{r}
hist(top$pval_filter, breaks = 70, freq = F, xlab = "one-way ANOVA p-values", 
                   main = paste("p-values distribution for top", topnum, 
                                 "\npeptide(s) with largest variance within protein") )
polygon_ind <- which(top_plot$density >= top$qval_eta0_filter)
for (i in polygon_ind){
  polygon( x = c(top_plot$breaks[i], top_plot$breaks[i+1], top_plot$breaks[i+1], top_plot$breaks[i]),
           y = c(top_plot$density[i], top_plot$density[i], top$qval_eta0_filter, top$qval_eta0_filter),
           col = "red")
}
text(x=0.65,y=4, labels = paste( "estimated proportion of \nnon-null peptides =",
                                    round( 100*(1 - top$qval_eta0_filter),2 ),"%" ))
```

Next, we tabulate peptide counts at different BH-adjusted p-values thresholds. 

```{r}
kable( count.func(top$BH_filter, seq(0.01, 0.1, by = 0.01)),
       format = "latex", row.names= NA, col.names = NA, booktabs = T )%>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%
  row_spec(1, hline_after = T)
```

Then, we tabulate peptide counts at different Storey's q-values thresholds. 

```{r}
kable( count.func(top$qval_filter, seq(0.01, 0.1, by = 0.01)),
       format = "latex", row.names= NA, col.names = NA, booktabs = T )%>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%
  row_spec(1, hline_after = T)
```


## Top peptide with largest marginal variance (As representative of protein)

Now, we filter top peptide with largest marginal variance in each protein. This can be taken as protein-level analysis as we take the peptide with largest marginal variance a representative of its corresponding protein. Then we plot histogram of p-values.

```{r, include = F}
topnum <- 1
top <- marginal_var_filter.func(one_way_anova_pval, topnum)
top_plot <- hist(top$pval_filter, breaks = 70, freq = F, xlab = "one-way ANOVA p-values", 
                   main = paste0("p-values distribution for top ", topnum, "\npeptide(s) with largest variance within protein") )
```

```{r}
hist(top$pval_filter, breaks = 70, freq = F, xlab = "one-way ANOVA p-values", 
                   main = paste("p-values distribution for top", topnum, 
                                 "\npeptide(s) with largest variance within protein") )
polygon_ind <- which(top_plot$density >= top$qval_eta0_filter)
for (i in polygon_ind){
  polygon( x = c(top_plot$breaks[i], top_plot$breaks[i+1], top_plot$breaks[i+1], top_plot$breaks[i]),
           y = c(top_plot$density[i], top_plot$density[i], top$qval_eta0_filter, top$qval_eta0_filter),
           col = "red")
}
text(x=0.65,y=4, labels = paste( "estimated proportion of \nnon-null peptides =",
                                    round( 100*(1 - top$qval_eta0_filter),2 ),"%" ))
```

Next, we tabulate peptide counts at different BH-adjusted p-values thresholds. 

```{r}
kable( count.func(top$BH_filter, seq(0.01, 0.1, by = 0.01)),
       format = "latex", row.names= NA, col.names = NA, booktabs = T )%>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%
  row_spec(1, hline_after = T)
```

Then, we tabulate peptide counts at different Storey's q-values thresholds. 

```{r}
kable( count.func(top$qval_filter, seq(0.01, 0.1, by = 0.01)),
       format = "latex", row.names= NA, col.names = NA, booktabs = T )%>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%
  row_spec(1, hline_after = T)
```

