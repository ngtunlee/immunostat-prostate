---
title: | 
  | Antibody Responses to Different Proteins 
  | in Prostate Cancer Patients  
author: "Tun Lee Ng and Michael A. Newton"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  pdf_document:
    toc: true
    number_sections: true
header-includes:
   \usepackage{enumerate}
   \usepackage{amsmath}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

# Introduction

This project aims to characterize antibody responses to a wide variety of proteins in prostate cancer patients at different stages of the disease. 16-mer peptides spanning the amino acid sequences of these 1611 gene products, and overlapping by 12 amino acids, were used to generate a microarray comprising 177,604 peptides. In this study, there were healthy subjects and patients with different stages of prostate cancer  

*  ``new_dx``: newly diagnosed,  
* ``nmCSPC``: non-metastatic castration-sensitive,  
* ``mCSPC``: metastatic castration-sensitive,  
* ``nmCRPC``: non-metastatic castration-resistant,  
* ``mCRPC``: metastatic castration-resistant 

```{r}
library(tidyverse) # make sure you have the latest tidyverse !
library(fdrtool)
library(Rtsne)
library(heatmap3)
library(kableExtra)
library(ggplot2)

####################################################################################### 
#                           Some Common Variables and Functions                       #
####################################################################################### 

# specified color and shape scheme 
pal <- c("navy", "cornflowerblue", "turquoise1", "orchid1", "darkorange1", "firebrick1")
names(pal) <- c("normal",  "new_dx", "nmCSPC", "mCSPC", "nmCRPC", "mCRPC")
shp <- c(8, 15, 16, 3, 17, 18)
names(shp) <- names(pal)

# function to plot PCA loadings
PCload.func <- function(cols, shapes, U, D, x, y, pca.vec, title){
  Z <- U %*% diag(D)
  plot(Z[,x], Z[,y], col = cols, pch = shapes, main = title,
       xlab = paste0("PC",x," (", round(pca.vec[x]*100, 1) ,"% variance explained)"),
        ylab = paste0("PC",y," (", round(pca.vec[y]*100, 1) ,"% variance explained)") 
  )
}

# function to count peptides at different FDR thresholds
count.func <- function(pval.vec, thresh.vec){
  counter <- NULL
  for (i in thresh.vec ){
    counter <- c(counter, length(pval.vec[pval.vec <= i]))
  }
  countab <- rbind(c("FDR threshold", thresh.vec),
                   c("Peptide counts", counter))
  return(countab)
}

####################################################################################### 
#                                      Data Processing                                #
####################################################################################### 

# We keep patients with rep = 1

array_id_key = read_csv("sample_key_project1.csv") %>%
  janitor::clean_names() %>%  # unify all column names to snake_case
  rename(stage = condition,
         array_id = "file_name") %>%
  mutate(id = str_replace_all(id, " ", ""),
         id = str_to_lower(id),
         id = str_replace_all(id, "/", ""),
         stage = as_factor(stage),
         stage = fct_recode(stage,  # rename factor levels
                            "normal" = "Normal_male_controls",
                            "new_dx" = "Newly_diagnosed",
                            "nmCSPC" = "PSA-recurrent_nonMet",
                            "mCSPC" = "Met",
                            "nmCRPC" = "Castration-resistent_nonMet",
                            "mCRPC" = "Castration-resistent_Met",
                            "binding_buffer" = "Binding buffer alone"))

# drop binding buffer
array_id_key <- array_id_key[!(array_id_key$stage=="binding_buffer"),]
array_id_key$stage <- factor(array_id_key$stage) # remove binding_buffer level

# check patient counts (NOT distinct patients)
kable( array_id_key %>%
  group_by(id, stage) %>%
  summarize() %>%
  group_by(stage) %>%
  tally(), format = "latex", booktabs = T ) %>%
  kable_styling(latex_options = c("hold_position"))
```

Note that these are not distinct patient counts, because there were 11 patients who were measured at two different stages. Number of replicates for each patient, ``rep`` could 1, 2, or 3. Hemanth removed patients with ``rep`` = 1. He also kept the latest distinct patient records only, so the distinct patient counts are: 

```{r, fig.height = 3.8}
# if you want to remove patients whose rep == 1
sample_key = array_id_key %>%
  group_by(id, stage) %>%
  summarize(n = n()) %>%  # assign (id,stage) group counts to the variable "n"
  ungroup() %>% 
  filter(n >= 2) %>%
  select(-n) # drop the column "n"
array_id_key = array_id_key %>%
  filter(id %in% sample_key$id)

ids_to_remove = c("pdv004", #1
                  "arv003", #2
                  "pap092", #3
                  "pap032", #4
                  "adt034", #5
                  "adt181", #6
                  "adt223", #7
                  "pdv008", #8
                  "pap123", #9
                  "pap067", #10
                  "adt143") #11

# drop patients' earlier records
array_id_key = array_id_key %>%
  filter(!(id %in% ids_to_remove))

# check patient counts (finally distinct patients)
distinct_patients_with_reps <- array_id_key %>%
  group_by(id, stage) %>%
  summarize() %>%
  group_by(stage) %>%
  tally()

# how many distinct patients with replicates
n <- sum(distinct_patients_with_reps$n)

# group unique patients by their id
sample_key = array_id_key %>%
  group_by(id, stage) %>%
  summarize(rep = n()) %>%  # assign (id,stage) group counts to the variable "n"
  ungroup()

# extract stages of patients
stage <- factor(sample_key$stage)

ggplot(data=distinct_patients_with_reps, aes(x=stage, y=n)) + 
  geom_bar(stat="identity", width=0.5 , fill="steelblue") + 
  geom_text(aes(label=n), vjust=-0.3, size=4) +
  theme_minimal()
```

Next, we take $\log_2$ transformation of the fluorescence intensity and compute the median of the replicates of each patient.  

```{r}
# we load pre-saved results:
# one-way anova p-values 
# Tukey-HSD adjusted p-values for the 10 contrasts of the 4538 peptides at 5% BH FDR
# (marginal) variance ranking of peptides within each protein
# anova_dat: log2 fluorescence level for the 4538 peptides at 5% BH FDR 

load("remove_rep1.RData")
```

# One-Way ANOVA

We would like to investigate if patients at different stages of prostate cancer exhibit different antibody responses to certain peptide chains or proteins. Let $\mu_i$ be the average fluorescence level (on $\log_2$ scale) of patients, with subscript $i$ indexing the different stages of prostate cancer as explained in Introduction section. We want to test whether  
$H_0$: All $\mu_i$'s are the same, ie. Antibody responses are the same for patients at different stages of prostate cancer.  
$H_1$: NOt all $\mu_i$'s are the same, ie. Antibody responses are not the same for patients at different stages of prostate cancer.  

For each peptide, we perform one-way ANOVA (analysis of variance). After getting p-values for all 177k peptides, we plot the p-value histogram.

```{r, include = F}
one_way_anova_BH <- p.adjust(one_way_anova_pval, method = "BH")
one_way_anova_qval <- fdrtool(one_way_anova_pval, statistic = "pvalue", verbose = F, plot  = F)$qval
qval_eta0 <- unname(fdrtool(one_way_anova_pval, statistic = "pvalue", verbose = F, plot  = F)$param[,"eta0"])

all_peptide_hist <- hist(one_way_anova_pval, breaks = 70, freq = F, 
                         xlab = "one-way ANOVA p-values", main = "p-values distribution for peptides")
```

```{r}
hist(one_way_anova_pval, breaks = 70, freq = F, 
                         xlab = "one-way ANOVA p-values", main = "p-values distribution for peptides")
polygon_ind <- which(all_peptide_hist$density >= qval_eta0)
for (i in polygon_ind){
  polygon( x = c(all_peptide_hist$breaks[i], all_peptide_hist$breaks[i+1], all_peptide_hist$breaks[i+1], all_peptide_hist$breaks[i]),
           y = c(all_peptide_hist$density[i], all_peptide_hist$density[i], qval_eta0, qval_eta0),
           col = "red")
}
text(x=0.65,y=4, labels = paste( "estimated proportion of \nnon-null peptides =",
                                 round( 100*(1 - qval_eta0),2 ),"%" ))
```

If cancer-stage effect is not present in our peptide array data, then the p-values from the ANOVA would have a uniform distribution between 0 and 1, and we expect to see a rather flat-shaped histogram of p-values.  
  
However, the p-values histogram exhibits large counts of significant p-values (p-values close to zero), and the shape of histogram flattens off exponentially with larger p-values. Such a large count of significant p-values may not be explained by false discovery alone, and that perhaps cancer-stage effect is indeed present in some of the peptides in our profile. The red-shaded regions of the histogram represents the estimated proportion of non-null peptides in the dataset based on Storey's q-values calculation obtained via the R package ``fdrtool``. The q-value is similar to the well known p-value, except that it is a measure of significance in terms of the false discovery rate rather than the false positive rate. The peptide counts at various q-values thresholds are tabulated below.

```{r}
kable( count.func(one_way_anova_qval, seq(0.01, 0.1, by = 0.01)),
       format = "latex", row.names= NA, col.names = NA, booktabs = T )%>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%
  row_spec(1, hline_after = T)
```

As a comparison, we also apply the Benjamini-Hochberg (BH) method on the ANOVA p-values to control for false discovery rate. The peptide counts at various FDR thresholds are tabulated below. 

```{r}
kable( count.func(one_way_anova_BH, seq(0.01, 0.1, by = 0.01)),
       format = "latex", row.names= NA, col.names = NA, booktabs = T )%>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%
  row_spec(1, hline_after = T)
```

It appears that the BH method gives a more conservative significant peptide counts. We export the list of 4538 peptides at 5\% BH FDR (together with the list of their corresponding proteins) onto the *"All_Peptides"* sheet in the Excel file *"BH_FDR_5prct.xlsx"*.   

# Visualization of One-Way ANOVA

We have identified 4538 peptides at 5\% Benjamini-Hochberg(BH) false discovery rate (FDR). We would like to obtain some graphical representations to illustrate how the $\log_2$ fluorescence levels differ across different cancer stages for these 4538 peptides.  

For each peptide, we remove the grand mean (row mean) of the $\log_2$ fluorescence levels for all patients, before applying the following visualization techniques:  

* Principal Component Analysis (PCA)  
* t-distributed Stochastic Neighbor Embedding (t-SNE)  
* Heatmap  

Based on our one-way-ANOVA model assumption, if there is no cancer-stage effect, we expect these residual $\log_2$ fluorescence to be random noises. Any observed (clustering) patterns among these residual data points reveal the effects of various stages of prostate cancer.  

For purpose of uniformity, we also use the same color scheme to distinguish the different stages of cancer patients (notice how the spectrum of colors changes with severity of the cancer stages):  

* navy for healthy subjects
* cornflower_blue for ``new_dx`` newly diagnosed patients
* turquoise for ``nmCSPC`` patients
* light pink for ``mCSPC`` patients -- these patients have no technical replicates and are excluded from this analysis
* dark orange for ``nmCSPC`` patients
* dark red for ``mCSPC`` patients 

```{r}
anova_dat_demean <- sweep(anova_dat, 1, rowMeans(anova_dat), "-") # centering by row

# colors and shapes for the visualization techniques
cols = pal[ match(stage, names(pal)) ]
shapes = shp[  match(stage, names(shp)) ]
```

## Principal Component Analysis (PCA)

First we apply principal component analysis (PCA).

```{r}
# svd
sv.dat <- sweep(t(anova_dat_demean), 2, colMeans(t(anova_dat_demean)), "-") # centering
sv <- svd(sv.dat)
V <- sv$v
D <- sv$d
U <- sv$u

# variance explained
pca.var <- D^2/sum(D^2) 
pca.cumvar <- cumsum(pca.var)

# plot PCA
par(mfrow = c(1,2), pty = "s", mar = c(2.2,2.3,1.5,0.45), mgp = c(1.4,0.4,0),
    cex.axis = 0.84, cex.lab = 0.84, cex.main = 0.84, tcl = -0.4)
PCload.func(cols, shapes, U, D, 1, 2, pca.var, title = "PC2 vs PC1") # PC loadings (PC2 vs PC1)
legend('topright', pch = shp, col = pal, cex = 0.5,
      c("normal",  "new_dx", "nmCSPC", "mCSPC", "nmCRPC", "mCRPC") )
PCload.func(cols, shapes, U, D, 3, 2, pca.var, title = "PC2 vs PC3") # PC loadings (PC2 vs PC3)
```

From the "\textit{PC2 vs PC1}" plot, we observe that all mCRPC points are clustered at the top of the panel, whereas nmCRPC observations hover at the bottom of panel. Normal (healthy) and new_dx (newly diagnosed) subjects are "all over the place". In the "\textit{PC2 vs PC3}" plot, we observe the same patterns, and most of the nmCSPC patients take up the left part of the panel. The percentage of variance explained for each principal component (PC) is shown on the axis.

## t-SNE (t-distributed Stochastic Neighbor Embedding)

Just like PCA, t-SNE is a dimensionality reduction technique which was first introduced by van der Maaten and Hinton in 2008.

```{r, fig.height = 6}
# how to specify parameter
# refer: https://lvdmaaten.github.io/tsne/User_guide.pdf
tsnedat <- unname(t(anova_dat_demean)) # dim(X) = N samples by D dimensions 
initdim <- 90 
perplex <- 30 

set.seed(10)
tsne_anova <- Rtsne(tsnedat, initial_dims = initdim, perplexity = perplex,
                  theta = 0, check_duplicates = F, max_iter = 50000L, eta = 50)

# t-SNE plot
plot(tsne_anova$Y, ylab = "", xlab = "", col = cols, pch = shapes, main = "t-SNE plot")
legend('topright', pch = shp, col = pal,
       c("normal",  "new_dx", "nmCSPC", "mCSPC", "nmCRPC", "mCRPC") )
```

From the t-SNE plot, we observe that:  

* The mCRPC points are clustered together near top-left of the plot.  
* The nmCRPC patients are not too far off from the mCRPC subjects. There seems to be 2 clusters of nmCRPC patients.  
* Most of the nmCSPC patients are clustered at the bottom right of the plot.  
* Normal and new_dx subjects are somewhat "all over the place".  

## HeatMap

Finally we plot the heatmap of the $\log_2$ fluorescence (after removing row means) of the 4538 peptides at 5\% BH-FDR.

```{r, fig.height = 10, fig.width = 8}
# heatmap color palette
cls <- colorRampPalette(c("navy", "white", "firebrick1", "firebrick3"))(n = 1024)

heatmap3(anova_dat_demean, 
         col = cls, # specify colors 
         ColSideColors = cols, # specify patient color code
         labCol = stage, # specify patient
         ColSideLabs = "stages", 
         labRow = "",
         xlab = "Patients",
         # legendfun=function() showLegend(col = c("navy", "cornflowerblue", "turquoise1", "orchid1", 
         #                                         "darkorange1", "firebrick1"),
         #                                 legend = c("normal",  "new_dx", "nmCSPC", "mCSPC", "nmCRPC", "mCRPC"),
         #                                 cex = 1.2,
         #                                 lwd = 5  )
)
```

Again, we observe similar patterns that nmCSPC (colored turquoise) and new_dx (colored cornflowerblue) subjects are mostly clustered to the left part of the heatmap, whereas the mCRPC (colored red) patients and most of the nmCRPC patients (colored darkorange) are clustered to the right part of the heatmap. Again, normal subjects (colored navy) are "all over the place".

# Tukey HSD (Honest Significant Difference)

The one-way ANOVA is helpful in revealing peptides that exhibit significant difference in the group means of $\log_2$ fluorescence levels among patients at different stages of cancer. We may be interested to find out which group or groups of patients that actually contribute to the significant difference in antibody responses.  

For the 4538 peptides at 5\% BH FDR, we proceed to perform the Tukey HSD analysis. Basically, it is a pairwise t-test (with standard error obtained from the previous one-way ANOVA and degrees of freedom adjusted for proper family-wise error rate) for all the possible contrasts (pairwise comparison of 2 groups of patients):

```{r}
colnames(tukey_adjusted_pval)
tukey_cutoff <- 0.05

# pairwise comparison pattern
# 1: at most cutoff, 0: more than cutoff
tukey_pairwise_pattern <- as.data.frame(sign( -1 * sign(tukey_adjusted_pval - tukey_cutoff) + 1 )) 

# boxplots specs
boxplot_col <- unname( pal[ match(levels(stage), names(pal)) ] )
boxplot_func <- function(mat, col = boxplot_col, draw){
  par(mar = c(2, 4.5, 2.3, 1),cex = 0.84)
  boxplot( as.numeric(mat[draw,]) ~ stage, 
           col=col, horizontal=TRUE, las=1, xlab = NA, ylab = NA,
           main= paste(row.names(boxplot_mat)[draw]) )
  abline( h=2.5, col="grey" )
  abline( h=4.5, col="grey" )
  abline( h=6.5, col="grey" )
}
```

For example, the peptide *ADT12;129* is identified to be significant at 5\% FDR. Upon closer inspection,

```{r, fig.height = 3.8}
example_tukey_df <- data.frame( 
  contrasts = names(tukey_adjusted_pval[1,]),
  Tukey_HSD_pvalues = unname(tukey_adjusted_pval[1,]) 
  )
ggplot(data=example_tukey_df, aes(x=contrasts, y=Tukey_HSD_pvalues)) + 
  geom_bar(stat="identity", width=0.5 , fill="steelblue") + 
  coord_flip() +
  theme_minimal() + 
  geom_hline(yintercept = 0.05, col = "red", lty = 2)
```

The Tukey HSD calculation reveals that for this peptide, the newly-diagnosed patients are the group of patients that are significantly different from the other groups in terms of antibody response. We export the table of Tukey HSD p-values of these 10 contrasts for the 4538 peptides to the *"Tukey_HSD"* sheet in the Excel file *"BH_FDR_5prct.xlsx"*. The table is also conditionally formatted to reveal cells that contain Tukey-HSD p-values of at most 0.05.    

Among the 4538 peptides at 5\% BH FDR, we plot the number of peptides that are found to be significant at 5\% Tukey HSD under the various contrasts:

```{r, fig.height = 3.8}
peptide_counts_df <- data.frame(
  contrasts = names(apply(tukey_adjusted_pval,2, function(x){length(x[x <= tukey_cutoff])})),
  peptide_counts = unname( apply(tukey_adjusted_pval,2, function(x){length(x[x <= tukey_cutoff])}) ) 
  ) 
ggplot(data=peptide_counts_df, aes(x=contrasts, y=peptide_counts)) + 
  geom_bar(stat="identity", width=0.5 , fill="steelblue") + 
  coord_flip() +
  geom_text(aes(label=peptide_counts), hjust=1.1, color = "white", size=4) +
  theme_minimal() 
```

We could also plot the boxplots of a few peptides deemed significant under some interesting contrasts. The x-axis of the boxplots refers to the $\log_2$ median fluorescence level of the patients. For example, we want to find peptides that are significantly different between healthy subjects and cancer patients (but not siginificant among the different stages of patients).

```{r, echo = T, fig.height = 2.8}
ind <- which(
    tukey_pairwise_pattern$"new_dx-normal" == 1 &
    tukey_pairwise_pattern$"nmCSPC-normal" == 1 &
    tukey_pairwise_pattern$"nmCRPC-normal" == 1 &
    tukey_pairwise_pattern$"mCRPC-normal"  == 1 &
    tukey_pairwise_pattern$"nmCSPC-new_dx" == 0 &
    tukey_pairwise_pattern$"nmCRPC-new_dx" == 0 &
    tukey_pairwise_pattern$"mCRPC-new_dx"  == 0 &
    tukey_pairwise_pattern$"nmCRPC-nmCSPC" == 0 &
    tukey_pairwise_pattern$"mCRPC-nmCSPC"  == 0 &
    tukey_pairwise_pattern$"mCRPC-nmCRPC"  == 0 &
    rank_variance[one_way_anova_BH <= 0.05] <= 3 # just to pick out the peptides 
  )
boxplot_mat <- anova_dat[ind,]
for (i in 1:nrow(boxplot_mat)){
  boxplot_func(mat = boxplot_mat, draw = i)
}
```

We can also look at peptides that are significantly different between mCRPC patients and the other subjects.

```{r, echo = T, fig.height = 2.8}
ind <- which(
    tukey_pairwise_pattern$"mCRPC-normal"  == 1 &
    tukey_pairwise_pattern$"mCRPC-new_dx"  == 1 &
    tukey_pairwise_pattern$"mCRPC-nmCSPC"  == 1 &
    tukey_pairwise_pattern$"mCRPC-nmCRPC"  == 1 &
    rank_variance[one_way_anova_BH <= 0.05] <= 13 # just to pick out some peptides with large marginal variance
  )
boxplot_mat <- anova_dat[ind,]
for (i in 1:nrow(boxplot_mat)){
  boxplot_func(mat = boxplot_mat, draw = i)
}
```


# Marginal Variance Filtering 

Next, we aim to identify proteins by first filtering for potentially "strong" peptides in terms of huge marginal variance of peptide fluorescence. Specifically, for every protein, we would like to filter the top few peptides with the largest marginal variance of $\log_2$ fluorescence before we apply FDR control. 

```{r}
# marginal variance filtering function
marginal_var_filter.func <- function(pval_vector, topnum){
  pval_filter = pval_vector[rank_variance <= topnum]
  BH_filter = p.adjust(pval_filter, method = "BH")
  qval_filter = fdrtool(pval_filter, statistic = "pvalue", verbose = F, plot  = F)$qval
  qval_eta0_filter = unname(fdrtool(pval_filter, statistic = "pvalue", verbose = F, plot  = F)$param[,"eta0"])
  return(list(
    pval_filter = pval_filter,
    BH_filter = BH_filter,
    qval_filter = qval_filter,
    qval_eta0_filter = qval_eta0_filter
  ))
}
```

## Top 5 peptides with largest marginal variance

First, we filter top 5 peptides with largest marginal variance in each protein. Then we plot histogram of p-values.

```{r, include = F}
topnum <- 5
top <- marginal_var_filter.func(one_way_anova_pval, topnum)
top_plot <- hist(top$pval_filter, breaks = 70, freq = F, xlab = "one-way ANOVA p-values", 
                   main = paste("p-values distribution for top ", topnum, 
                                 "peptide(s) with largest variance within protein") )
```

```{r}
hist(top$pval_filter, breaks = 70, freq = F, xlab = "one-way ANOVA p-values", 
                   main = paste("p-values distribution for top", topnum, 
                                 "\npeptide(s) with largest variance within protein") )
polygon_ind <- which(top_plot$density >= top$qval_eta0_filter)
for (i in polygon_ind){
  polygon( x = c(top_plot$breaks[i], top_plot$breaks[i+1], top_plot$breaks[i+1], top_plot$breaks[i]),
           y = c(top_plot$density[i], top_plot$density[i], top$qval_eta0_filter, top$qval_eta0_filter),
           col = "red")
}
text(x=0.65,y=4, labels = paste( "estimated proportion of \nnon-null peptides =",
                                    round( 100*(1 - top$qval_eta0_filter),2 ),"%" ))
```

Next, we tabulate peptide counts at different BH-adjusted p-values thresholds.

```{r}
kable( count.func(top$BH_filter, seq(0.01, 0.1, by = 0.01)),
       format = "latex", row.names= NA, col.names = NA, booktabs = T )%>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%
  row_spec(1, hline_after = T)
```

The list of significant peptides (and their corresponding proteins) at 5\% BH FDR could be found on the *"Top_5"* sheet in the Excel file *"BH_FDR_5prct.xlsx"*. We also tabulate peptide counts at different Storey's q-values thresholds. 

```{r}
kable( count.func(top$qval_filter, seq(0.01, 0.1, by = 0.01)),
       format = "latex", row.names= NA, col.names = NA, booktabs = T )%>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%
  row_spec(1, hline_after = T)
```

## Top 3 peptides with largest marginal variance

Now, we filter top 3 peptides with largest marginal variance in each protein. Then we plot histogram of p-values.

```{r, include = F}
topnum <- 3
top <- marginal_var_filter.func(one_way_anova_pval, topnum)
top_plot <- hist(top$pval_filter, breaks = 70, freq = F, xlab = "one-way ANOVA p-values", 
                   main = paste("p-values distribution for top ", topnum, 
                                 "peptide(s) with largest variance within protein") )
```

```{r}
hist(top$pval_filter, breaks = 70, freq = F, xlab = "one-way ANOVA p-values", 
                   main = paste("p-values distribution for top", topnum, 
                                 "\npeptide(s) with largest variance within protein") )
polygon_ind <- which(top_plot$density >= top$qval_eta0_filter)
for (i in polygon_ind){
  polygon( x = c(top_plot$breaks[i], top_plot$breaks[i+1], top_plot$breaks[i+1], top_plot$breaks[i]),
           y = c(top_plot$density[i], top_plot$density[i], top$qval_eta0_filter, top$qval_eta0_filter),
           col = "red")
}
text(x=0.65,y=4, labels = paste( "estimated proportion of \nnon-null peptides =",
                                    round( 100*(1 - top$qval_eta0_filter),2 ),"%" ))
```

Next, we tabulate peptide counts at different BH-adjusted p-values thresholds.

```{r}
kable( count.func(top$BH_filter, seq(0.01, 0.1, by = 0.01)),
       format = "latex", row.names= NA, col.names = NA, booktabs = T )%>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%
  row_spec(1, hline_after = T)
```

The list of significant peptides (and their corresponding proteins) at 5\% BH FDR could be found on the *"Top_3"* sheet in the Excel file *"BH_FDR_5prct.xlsx"*. We also tabulate peptide counts at different Storey's q-values thresholds. 

```{r}
kable( count.func(top$qval_filter, seq(0.01, 0.1, by = 0.01)),
       format = "latex", row.names= NA, col.names = NA, booktabs = T )%>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%
  row_spec(1, hline_after = T)
```

## Top peptide with largest marginal variance 

Now, we filter top peptide with largest marginal variance in each protein. This can be taken as protein-level analysis as we take the peptide with largest marginal variance a representative of its corresponding protein. Then we plot histogram of p-values.

```{r, include = F}
topnum <- 1
top <- marginal_var_filter.func(one_way_anova_pval, topnum)
top_plot <- hist(top$pval_filter, breaks = 70, freq = F, xlab = "one-way ANOVA p-values", 
                   main = paste("p-values distribution for top ", topnum, 
                                 "peptide(s) with largest variance within protein") )
```

```{r}
hist(top$pval_filter, breaks = 70, freq = F, xlab = "one-way ANOVA p-values", 
                   main = paste("p-values distribution for top", topnum, 
                                 "\npeptide(s) with largest variance within protein") )
polygon_ind <- which(top_plot$density >= top$qval_eta0_filter)
for (i in polygon_ind){
  polygon( x = c(top_plot$breaks[i], top_plot$breaks[i+1], top_plot$breaks[i+1], top_plot$breaks[i]),
           y = c(top_plot$density[i], top_plot$density[i], top$qval_eta0_filter, top$qval_eta0_filter),
           col = "red")
}
text(x=0.65,y=4, labels = paste( "estimated proportion of \nnon-null peptides =",
                                    round( 100*(1 - top$qval_eta0_filter),2 ),"%" ))
```

Next, we tabulate peptide counts at different BH-adjusted p-values thresholds.

```{r}
kable( count.func(top$BH_filter, seq(0.01, 0.1, by = 0.01)),
       format = "latex", row.names= NA, col.names = NA, booktabs = T )%>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%
  row_spec(1, hline_after = T)
```

The list of significant peptides (and their corresponding proteins) at 5\% BH FDR could be found on the *"Top_1"* sheet in the Excel file *"BH_FDR_5prct.xlsx"*. We also tabulate peptide counts at different Storey's q-values thresholds. 

```{r}
kable( count.func(top$qval_filter, seq(0.01, 0.1, by = 0.01)),
       format = "latex", row.names= NA, col.names = NA, booktabs = T )%>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%
  row_spec(1, hline_after = T)
```


